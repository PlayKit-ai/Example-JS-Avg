<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹è¯ç³»ç»Ÿæµ‹è¯• v2</title>
    <link rel="icon" type="image/png" href="styles/spray_i358.PNG">
    <link rel="shortcut icon" type="image/png" href="styles/spray_i358.PNG">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #fff;
        }
        h1 { color: #ff69b4; text-align: center; }
        .test-container {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        h3 { color: #ff69b4; margin-top: 0; }
        .test-input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            margin-bottom: 10px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 14px;
        }
        .test-input::placeholder { color: rgba(255,255,255,0.5); }
        .test-button {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .test-button:hover { opacity: 0.9; }
        .test-result {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
            border-left: 3px solid #ff69b4;
        }
        .good { color: #4ade80; }
        .bad { color: #f87171; }
        .warning { color: #fbbf24; }
        .example-bad {
            background: rgba(248,113,113,0.2);
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 3px solid #f87171;
        }
        .example-good {
            background: rgba(74,222,128,0.2);
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 3px solid #4ade80;
        }
    </style>
</head>
<body>
    <h1>ğŸ­ AIå¯¹è¯ç³»ç»Ÿæµ‹è¯• v2</h1>
    
    <div class="test-container">
        <h3>ğŸ”§ åå¤„ç†æµ‹è¯• - è¿‡æ»¤AIåˆ†ææ€§å›å¤</h3>
        <p style="color: rgba(255,255,255,0.7); font-size: 13px;">æµ‹è¯•AIå›å¤çš„åå¤„ç†ï¼Œçœ‹çœ‹èƒ½å¦æ­£ç¡®è¿‡æ»¤æ‰åˆ†ææ€§è¯­è¨€</p>
        
        <div class="example-bad">
            <strong>âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆAIåœ¨åˆ†æè€Œä¸æ˜¯å¯¹è¯ï¼‰ï¼š</strong><br>
            å¥½çš„ï¼Œéœ€è¦æ„å»ºä¸€ä¸ªè‡ªç„¶çš„å¯¹è¯åœºæ™¯ã€‚åœ¨åŒ—æ–¹çš„å…¬å›­é‡Œï¼Œå—æ–¹è½¬æ ¡ç”Ÿå¤æ €å¯¹è¿™é‡Œçš„ç¯å¢ƒè¿˜å¾ˆé™Œç”Ÿ...
        </div>
        <div class="example-good">
            <strong>âœ… æ­£ç¡®ç¤ºä¾‹ï¼ˆè‡ªç„¶å¯¹è¯ï¼‰ï¼š</strong><br>
            è¯¶ï¼Ÿè¿™ä¸ªå…¬å›­å¥½å¤§å‘€ï¼ï¼ˆå››å¤„å¼ æœ›ï¼‰ä½ çŸ¥é“å“ªé‡Œæœ‰é•¿æ¤…å—~
        </div>
        
        <textarea class="test-input" id="rawMessage" placeholder="è¾“å…¥AIçš„åŸå§‹å›å¤..." rows="4">å¥½çš„ï¼Œéœ€è¦æ„å»ºä¸€ä¸ªè‡ªç„¶çš„å¯¹è¯åœºæ™¯ã€‚åœ¨åŒ—æ–¹çš„å…¬å›­é‡Œï¼Œå—æ–¹è½¬æ ¡ç”Ÿå¤æ €å¯¹è¿™é‡Œçš„ç¯å¢ƒè¿˜å¾ˆé™Œç”Ÿã€‚å¥¹æ€§æ ¼æ´»æ³¼ï¼Œå¸¦ç€ä¸€æœ¬è¯—é›†ï¼Œå´åœ¨æ‰¾åœ°æ–¹æ—¶é‡åˆ°äº†å°éº»çƒ¦ã€‚"è¯¶ï¼Ÿè¿™ä¸ªå…¬å›­å¥½å¤§å‘€ï¼ä½ çŸ¥é“å“ªé‡Œæœ‰é•¿æ¤…å—~"</textarea>
        <button class="test-button" onclick="testPostProcess()">æµ‹è¯•åå¤„ç†</button>
        <div class="test-result" id="postProcessResult"></div>
    </div>

    <div class="test-container">
        <h3>ğŸ“ ç³»ç»Ÿæç¤ºè¯é¢„è§ˆ</h3>
        <p style="color: rgba(255,255,255,0.7); font-size: 13px;">æŸ¥çœ‹æ–°çš„æç®€ç³»ç»Ÿæç¤ºè¯</p>
        
        <input class="test-input" id="charName" placeholder="è§’è‰²åç§°" value="å¤æ €">
        <textarea class="test-input" id="charSettings" placeholder="è§’è‰²è®¾å®š" rows="2">å—æ–¹è½¬æ¥çš„å¤§å­¦ç”Ÿï¼Œæ€§æ ¼æ´»æ³¼å¼€æœ—ï¼Œå–œæ¬¢æ–‡å­¦ï¼Œæœ‰ç‚¹å°è¿·ç³Š</textarea>
        <button class="test-button" onclick="showPrompt()">ç”Ÿæˆæç¤ºè¯</button>
        <div class="test-result" id="promptResult"></div>
    </div>

    <div class="test-container">
        <h3>ğŸ§ª æ‰¹é‡æµ‹è¯•</h3>
        <p style="color: rgba(255,255,255,0.7); font-size: 13px;">æµ‹è¯•å¤šä¸ªå…¸å‹çš„é”™è¯¯å›å¤</p>
        <button class="test-button" onclick="batchTest()">è¿è¡Œæ‰¹é‡æµ‹è¯•</button>
        <div class="test-result" id="batchResult"></div>
    </div>

    <script>
        // åå¤„ç†å‡½æ•° - ä¸DialogueSystem.jsä¿æŒä¸€è‡´
        function postProcessReply(reply) {
            if (!reply) return 'å—¯ï¼Ÿ';
            
            let processed = reply;
            
            // æ£€æµ‹æ˜¯å¦æ˜¯åˆ†ææ€§å›å¤
            const analysisIndicators = [
                'å¥½çš„ï¼Œ', 'å¥½çš„,', 'éœ€è¦', 'å¯ä»¥', 'åº”è¯¥', 'ä¼šè¡¨ç°', 'ä¼šå±•ç°',
                'æ„å»º', 'åœºæ™¯', 'è®¾å®š', 'è§„åˆ™', 'ä»»åŠ¡', 'å›åº”', 'å¯¹è¯',
                'ä½œä¸º', 'æ ¹æ®', 'åŒæ—¶', 'æ­¤æ—¶', 'æ­£åœ¨', 'è¡¨ç°å‡º',
                'æ€§æ ¼', 'ç‰¹è´¨', 'è§’è‰²', 'ç”¨æˆ·', 'ç©å®¶'
            ];
            
            const isAnalysisReply = analysisIndicators.some(indicator => 
                processed.includes(indicator)
            );
            
            if (isAnalysisReply) {
                // å°è¯•æå–å¼•å·å†…çš„å¯¹è¯å†…å®¹
                const quotedMatch = processed.match(/["ã€Œã€"']([^"ã€ã€"']+)["ã€ã€"']/);
                if (quotedMatch && quotedMatch[1].length > 2) {
                    processed = quotedMatch[1];
                } else {
                    // å°è¯•æå–åŠ¨ä½œæå†™åçš„å†…å®¹
                    const actionMatch = processed.match(/[ï¼ˆ(][^ï¼‰)]+[ï¼‰)](.+)/);
                    if (actionMatch && actionMatch[1].trim().length > 2) {
                        processed = actionMatch[0];
                    } else {
                        // å°è¯•æå–æœ€åä¸€å¥è¯
                        const sentences = processed.split(/[ã€‚ï¼ï¼Ÿ~]/);
                        const lastValidSentence = sentences.reverse().find(s => {
                            const trimmed = s.trim();
                            return trimmed.length > 2 && 
                                   !trimmed.includes('éœ€è¦') && 
                                   !trimmed.includes('å¯ä»¥') &&
                                   !trimmed.includes('å¥½çš„') &&
                                   !trimmed.includes('è®¾å®š') &&
                                   !trimmed.includes('åœºæ™¯');
                        });
                        
                        if (lastValidSentence) {
                            processed = lastValidSentence.trim();
                        } else {
                            processed = generateFallback();
                        }
                    }
                }
            }
            
            // æ¸…ç†æ®‹ç•™çš„åˆ†ææ€§è¯­è¨€
            const cleanPatterns = [
                /^å¥½çš„[ï¼Œ,]?/g,
                /^éœ€è¦[^ï¼Œã€‚]*[ï¼Œã€‚]/g,
                /^å¯ä»¥[^ï¼Œã€‚]*[ï¼Œã€‚]/g,
                /^åŒæ—¶[^ï¼Œã€‚]*[ï¼Œã€‚]/g,
                /^æ­¤æ—¶[^ï¼Œã€‚]*[ï¼Œã€‚]/g,
            ];
            
            cleanPatterns.forEach(pattern => {
                processed = processed.replace(pattern, '');
            });
            
            // æ¸…ç†
            processed = processed.trim();
            processed = processed.replace(/^[ï¼Œã€‚ï¼ï¼Ÿ~\s]+/, '');
            processed = processed.replace(/[ï¼Œ\s]+$/, '');
            
            if (!processed || processed.length < 2) {
                processed = generateFallback();
            }
            
            // æ§åˆ¶é•¿åº¦
            if (processed.length > 50) {
                processed = smartTruncate(processed, 50);
            }
            
            // æ·»åŠ ç»“å°¾
            if (!/[ã€‚ï¼ï¼Ÿ~ï¼‰)ã€ã€]$/.test(processed)) {
                processed = addEnding(processed);
            }
            
            return processed;
        }

        function generateFallback() {
            const fallbacks = ['å—¯ï¼Ÿæ€ä¹ˆäº†~', 'è¯¶ï¼Ÿ', 'å•Š...æ˜¯å—ï¼Ÿ', 'å“¦å“¦~', 'å˜¿å˜¿~'];
            return fallbacks[Math.floor(Math.random() * fallbacks.length)];
        }

        function smartTruncate(text, maxLength) {
            if (text.length <= maxLength) return text;
            const punctuations = ['ã€‚', 'ï¼', 'ï¼Ÿ', '~', 'ï¼Œ'];
            for (const punct of punctuations) {
                const idx = text.lastIndexOf(punct, maxLength);
                if (idx > 10) return text.substring(0, idx + 1);
            }
            return text.substring(0, maxLength - 3) + '...';
        }

        function addEnding(text) {
            if (/[å—å‘¢]$/.test(text)) return text + 'ï¼Ÿ';
            if (/[å•Šå“¦å—¯å‘€]$/.test(text)) return text + '~';
            const endings = ['~', 'ï¼', 'ã€‚'];
            return text + endings[Math.floor(Math.random() * endings.length)];
        }

        function testPostProcess() {
            const raw = document.getElementById('rawMessage').value;
            const result = postProcessReply(raw);
            
            const isGood = !result.includes('éœ€è¦') && !result.includes('å¥½çš„ï¼Œ') && 
                          !result.includes('åœºæ™¯') && !result.includes('è®¾å®š');
            
            document.getElementById('postProcessResult').innerHTML = `
<span class="${isGood ? 'good' : 'bad'}">ã€${isGood ? 'âœ… å¤„ç†æˆåŠŸ' : 'âŒ ä»æœ‰é—®é¢˜'}ã€‘</span>

<span class="warning">åŸå§‹å›å¤ (${raw.length}å­—):</span>
${raw}

<span class="good">å¤„ç†å (${result.length}å­—):</span>
${result}
            `;
        }

        function showPrompt() {
            const name = document.getElementById('charName').value;
            const settings = document.getElementById('charSettings').value;
            
            const prompt = `ä½ ç°åœ¨æ˜¯${name}ï¼Œä¸æ˜¯AIåŠ©æ‰‹ã€‚

è§’è‰²èƒŒæ™¯ï¼š${settings}

ã€ç»å¯¹ç¦æ­¢ã€‘
- ç¦æ­¢è¯´"å¥½çš„"ã€"éœ€è¦"ã€"å¯ä»¥"å¼€å¤´
- ç¦æ­¢åˆ†æè§’è‰²ã€åˆ†æåœºæ™¯ã€åˆ†æä»»åŠ¡
- ç¦æ­¢è¯´"ä½œä¸º"ã€"æ ¹æ®"ã€"è®¾å®š"ã€"è§„åˆ™"
- ç¦æ­¢ç”¨ç¬¬ä¸‰äººç§°æè¿°è‡ªå·±
- ç¦æ­¢è§£é‡Šä½ è¦åšä»€ä¹ˆ

ã€å¿…é¡»éµå®ˆã€‘
- ç›´æ¥ç”¨${name}çš„èº«ä»½è¯´è¯
- åƒçœŸäººèŠå¤©ä¸€æ ·ç®€çŸ­è‡ªç„¶
- ç”¨"æˆ‘"ç§°å‘¼è‡ªå·±
- å›å¤æ§åˆ¶åœ¨30å­—ä»¥å†…

ã€å›å¤æ ¼å¼ã€‘
åªè¾“å‡º${name}è¯´çš„è¯ï¼Œå¯ä»¥åŠ åŠ¨ä½œæå†™å¦‚ï¼ˆç¬‘ï¼‰ã€*æ­ªå¤´*

é”™è¯¯ç¤ºèŒƒï¼šå¥½çš„ï¼Œéœ€è¦æ„å»ºä¸€ä¸ªè‡ªç„¶çš„å¯¹è¯åœºæ™¯...
æ­£ç¡®ç¤ºèŒƒï¼šè¯¶ï¼Ÿä½ æ€ä¹ˆæ¥äº†å‘€~ï¼ˆæƒŠå–œåœ°çœ‹ç€ä½ ï¼‰

ç°åœ¨ç”¨æˆ·å¯¹ä½ è¯´è¯ï¼Œç›´æ¥å›åº”ï¼š`;

            document.getElementById('promptResult').textContent = prompt;
        }

        function batchTest() {
            const testCases = [
                'å¥½çš„ï¼Œéœ€è¦æ„å»ºä¸€ä¸ªè‡ªç„¶çš„å¯¹è¯åœºæ™¯ã€‚åœ¨åŒ—æ–¹çš„å…¬å›­é‡Œï¼Œå—æ–¹è½¬æ ¡ç”Ÿå¤æ €å¯¹è¿™é‡Œçš„ç¯å¢ƒè¿˜å¾ˆé™Œç”Ÿã€‚',
                'å¥½çš„ï¼Œæ­¤æ—¶æ­£åœ¨å›¾ä¹¦é¦†èµ¶ä½œä¸šï¼Œå¯ä»¥è¡¨ç°å‡ºäº›è®¸å°è¿·ç³Šçš„ç‰¹è´¨ã€‚',
                'å¥½çš„ï¼Œå¤æ €ä½œä¸ºä¸€ä¸ªä»å—æ–¹è½¬æ¥çš„å¤§å­¦ç”Ÿï¼Œå¯¹åŒ—æ–¹çš„å…¬å›­è‚¯å®šå……æ»¡å¥½å¥‡ã€‚å¥¹æ€§æ ¼æ´»æ³¼å¼€æœ—ï¼Œå–œæ¬¢æ–‡å­¦ï¼Œæ‰€ä»¥ä¼šæƒ³åˆ°å¸¦ç€è¯—é›†å»å…¬å›­ã€‚',
                'å¥½çš„ï¼ŒåŒæ—¶æ³¨æ„å¯¹è¯è§„åˆ™~',
                'ï¼ˆåœ¨é£Ÿå ‚æ’é˜Ÿæ—¶ï¼Œæˆ³äº†æˆ³ä½ çš„åèƒŒï¼‰å—¨ï¼ä½ æ˜¯ä¸æ˜¯é‚£ä¸ªæ ¡åˆŠç¼–è¾‘éƒ¨çš„é™†æ˜Ÿé‡ï¼Ÿ',
                'è¯¶ï¼Ÿè¿™ä¸ªå…¬å›­å¥½å¤§å‘€ï¼ï¼ˆå››å¤„å¼ æœ›ï¼‰ä½ çŸ¥é“å“ªé‡Œæœ‰é•¿æ¤…å—~'
            ];
            
            let results = '<strong>æ‰¹é‡æµ‹è¯•ç»“æœï¼š</strong>\n\n';
            
            testCases.forEach((testCase, i) => {
                const result = postProcessReply(testCase);
                const isGood = !result.includes('éœ€è¦') && !result.includes('å¥½çš„ï¼Œ') && 
                              !result.includes('åœºæ™¯') && !result.includes('è®¾å®š') &&
                              !result.includes('è§„åˆ™');
                
                results += `<span class="${isGood ? 'good' : 'bad'}">${isGood ? 'âœ…' : 'âŒ'} æµ‹è¯• ${i+1}:</span>\n`;
                results += `   åŸå§‹: ${testCase.substring(0, 50)}...\n`;
                results += `   ç»“æœ: ${result}\n\n`;
            });
            
            document.getElementById('batchResult').innerHTML = results;
        }
    </script>
</body>
</html>